---
// Enhanced code blocks with copy button and line highlights
---

<style>
  .code-block-wrapper {
    position: relative;
    margin: 1.5em 0;
  }

  .code-block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-elevated);
    border: 1px solid var(--code-border);
    border-bottom: none;
    border-radius: var(--radius) var(--radius) 0 0;
    padding: 8px 16px;
    font-size: 0.85em;
  }

  .code-language {
    color: var(--accent-primary);
    font-weight: 600;
    font-family: ui-monospace, monospace;
    text-transform: uppercase;
    font-size: 0.75em;
    letter-spacing: 0.05em;
  }

  .copy-button {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--line);
    color: var(--text-muted);
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.8em;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: ui-sans-serif, system-ui;
  }

  .copy-button:hover {
    background: rgba(255,255,255,0.1);
    border-color: var(--accent-primary-glow);
    color: var(--text);
  }

  .copy-button.copied {
    background: var(--accent-primary-subtle);
    border-color: var(--accent-primary);
    color: var(--accent-primary);
  }

  .copy-icon {
    width: 14px;
    height: 14px;
  }

  .code-block-wrapper pre {
    margin: 0;
    border-radius: 0 0 var(--radius) var(--radius);
  }

  .code-block-wrapper:not(:has(.code-block-header)) pre {
    border-radius: var(--radius);
  }
</style>

<script>
  function enhanceCodeBlocks() {
    const preBlocks = document.querySelectorAll('article pre:not(.astro-code), main pre:not(.astro-code)');
    
    preBlocks.forEach((pre) => {
      const preElement = pre as HTMLElement;
      
      // Skip if already enhanced, is mermaid, or is inline (has no parent paragraph context)
      if (preElement.parentElement?.classList.contains('code-block-wrapper') || 
          preElement.querySelector('.language-mermaid') ||
          preElement.closest('p')) {
        return;
      }
      
      const code = preElement.querySelector('code');
      if (!code) return;
      
      const codeText = code.textContent || '';
      
      // Skip very short code blocks (likely inline)
      if (codeText.trim().split('\n').length < 2) {
        return;
      }
      
      const language = Array.from(code.classList)
        .find(cls => cls.startsWith('language-'))
        ?.replace('language-', '') || 'text';
      
      // Skip plain text, diagrams, and unlabeled blocks
      if (!language || language === 'text' || language === 'plaintext' || language === 'txt') {
        return;
      }
      
      // Create wrapper
      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      
      // Create header
      const header = document.createElement('div');
      header.className = 'code-block-header';
      
      const langLabel = document.createElement('span');
      langLabel.className = 'code-language';
      langLabel.textContent = language;
      
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-button';
      copyBtn.innerHTML = `
        <svg class="copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <span>Copy</span>
      `;
      
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(codeText);
          copyBtn.classList.add('copied');
          const span = copyBtn.querySelector('span');
          if (span) span.textContent = 'Copied!';
          
          setTimeout(() => {
            copyBtn.classList.remove('copied');
            if (span) span.textContent = 'Copy';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
      
      header.appendChild(langLabel);
      header.appendChild(copyBtn);
      
      // Wrap pre block
      preElement.parentNode?.insertBefore(wrapper, preElement);
      wrapper.appendChild(header);
      wrapper.appendChild(preElement);
    });
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', enhanceCodeBlocks);
  document.addEventListener('astro:after-swap', enhanceCodeBlocks);
</script>
